
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>PLC Project (1): Library &#8212; pcdshub/lcls2-cc-lib  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Library.tmc" href="Library.tmc.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="plc-project-1-library">
<h1>PLC Project (1): Library<a class="headerlink" href="#plc-project-1-library" title="Permalink to this headline">¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Project</span> <span class="n">root</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">travis</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">pcdshub</span><span class="o">/</span><span class="n">lcls2</span><span class="o">-</span><span class="n">cc</span><span class="o">-</span><span class="n">lib</span><span class="o">/</span><span class="n">lcls2</span><span class="o">-</span><span class="n">cc</span><span class="o">-</span><span class="n">lib</span>
<span class="n">Project</span> <span class="n">path</span><span class="p">:</span> <span class="n">Library</span><span class="o">/</span><span class="n">Library</span><span class="o">.</span><span class="n">plcproj</span>
<span class="n">TMC</span> <span class="n">path</span><span class="p">:</span>     <span class="n">Library</span><span class="o">/</span><span class="n">Library</span><span class="o">.</span><span class="n">tmc</span>
<span class="n">AMS</span> <span class="n">ID</span><span class="p">:</span>       
<span class="n">IP</span> <span class="n">Address</span><span class="p">:</span>    <span class="p">(</span><span class="o">*</span> <span class="n">based</span> <span class="n">on</span> <span class="n">AMS</span> <span class="n">ID</span><span class="p">)</span>
<span class="n">Port</span><span class="p">:</span>         <span class="mi">851</span>

<span class="n">Source</span> <span class="n">files</span><span class="p">:</span>
    <span class="mf">1.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">PPM</span><span class="o">/</span><span class="n">ENUM_PPM_States</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">2.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">PPM</span><span class="o">/</span><span class="n">FB_PPM</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">3.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">PPM</span><span class="o">/</span><span class="n">FB_PPM_Gige</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">4.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">PPM</span><span class="o">/</span><span class="n">FB_PPM_PowerMeter</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">5.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">PPM</span><span class="o">/</span><span class="n">FB_PPM_States</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">6.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">REF</span><span class="o">/</span><span class="n">FB_REF</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">7.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">REF</span><span class="o">/</span><span class="n">FB_REF_Laser</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">8.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">SLITS</span><span class="o">/</span><span class="n">FB_SLITS</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">9.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">SLITS</span><span class="o">/</span><span class="n">FB_SLITS_POWER</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">10.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">ENUM_XPIM_Filters</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">11.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">ENUM_XPIM_States</span><span class="o">.</span><span class="n">TcDUT</span>
    <span class="mf">12.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">FB_XPIM</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">13.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">FB_XPIM_FilterWheel</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">14.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">FB_XPIM_Opal</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">15.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">FB_XPIM_States</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">16.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">FB_L2SI_Flowmeter</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">17.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">POUs</span><span class="o">/</span><span class="n">FB_XTES_Flowswitch</span><span class="o">.</span><span class="n">TcPOU</span>
    <span class="mf">18.</span><span class="p">)</span> <span class="n">Library</span><span class="o">/</span><span class="n">Version</span><span class="o">/</span><span class="n">Global_Version</span><span class="o">.</span><span class="n">TcGVL</span>

<span class="n">POUs</span><span class="p">:</span>
    <span class="mf">1.</span><span class="p">)</span> <span class="n">FB_L2SI_Flowmeter</span>
    <span class="mf">2.</span><span class="p">)</span> <span class="n">FB_PPM</span>
    <span class="mf">3.</span><span class="p">)</span> <span class="n">FB_PPM_Gige</span>
    <span class="mf">4.</span><span class="p">)</span> <span class="n">FB_PPM_PowerMeter</span>
    <span class="mf">5.</span><span class="p">)</span> <span class="n">FB_PPM_States</span>
    <span class="mf">6.</span><span class="p">)</span> <span class="n">FB_REF</span>
    <span class="mf">7.</span><span class="p">)</span> <span class="n">FB_REF_Laser</span>
    <span class="mf">8.</span><span class="p">)</span> <span class="n">FB_SLITS</span>
    <span class="mf">9.</span><span class="p">)</span> <span class="n">FB_SLITS_POWER</span>
    <span class="mf">10.</span><span class="p">)</span> <span class="n">FB_XPIM</span>
    <span class="mf">11.</span><span class="p">)</span> <span class="n">FB_XPIM_FilterWheel</span>
    <span class="mf">12.</span><span class="p">)</span> <span class="n">FB_XPIM_Opal</span>
    <span class="mf">13.</span><span class="p">)</span> <span class="n">FB_XPIM_States</span>
    <span class="mf">14.</span><span class="p">)</span> <span class="n">FB_XTES_Flowswitch</span>

<span class="n">GVLs</span><span class="p">:</span>
    <span class="mf">1.</span><span class="p">)</span> <span class="n">Global_Version</span>
</pre></div>
</div>
<div class="section" id="dut-enum-ppm-states">
<h2>DUT: ENUM_PPM_States<a class="headerlink" href="#dut-enum-ppm-states" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/PPM/ENUM_PPM_States.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>{attribute &#39;qualified_only&#39;}
TYPE ENUM_PPM_States :
(
    Unknown := 0,
    Out := 1,
    PowerMeter := 2,
    PolishedYag := 3,
    FrostedYag := 4
);
END_TYPE
</pre></div>
</div>
</div>
<div class="section" id="dut-enum-xpim-filters">
<h2>DUT: ENUM_XPIM_Filters<a class="headerlink" href="#dut-enum-xpim-filters" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/XPIM/ENUM_XPIM_Filters.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>{attribute &#39;qualified_only&#39;}
TYPE ENUM_XPIM_Filters :
(
    Unknown := 0,
    T50 := 1,
    T25 := 2,
    T10 := 3,
    T5 := 4,
    T1 := 5,
    T100 := 6
);
END_TYPE
</pre></div>
</div>
</div>
<div class="section" id="dut-enum-xpim-states">
<h2>DUT: ENUM_XPIM_States<a class="headerlink" href="#dut-enum-xpim-states" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/XPIM/ENUM_XPIM_States.TcDUT</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>{attribute &#39;qualified_only&#39;}
TYPE ENUM_XPIM_States :
(
    Unknown := 0,
    Out := 1,
    Yag := 2,
    Diamond := 3,
    Reticle := 4
);
END_TYPE
</pre></div>
</div>
</div>
<div class="section" id="gvl-global-version">
<h2>GVL: Global_Version<a class="headerlink" href="#gvl-global-version" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Version/Global_Version.TcGVL</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>{attribute &#39;TcGenerated&#39;}
{attribute &#39;no-analysis&#39;}
// This function has been automatically generated from the project information.
VAR_GLOBAL CONSTANT
    {attribute &#39;const_non_replaced&#39;}
    {attribute &#39;linkalways&#39;}
    stLibVersion_lcls2_cc_lib : ST_LibVersion := (iMajor := 0, iMinor := 0, iBuild := 0, iRevision := 0, sVersion := &#39;0.0.0&#39;);
END_VAR
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-l2si-flowmeter">
<h2>POU: FB_L2SI_Flowmeter<a class="headerlink" href="#pou-fb-l2si-flowmeter" title="Permalink to this headline">¶</a></h2>
<p>File: Library/POUs/FB_L2SI_Flowmeter.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_L2SI_Flowmeter
VAR
    {attribute &#39;pytmc&#39; := &#39;
        pv: MA
        io: input
    &#39;}
    fRaw AT %I*: INT;

    {attribute &#39;pytmc&#39; := &#39;
        pv: FLOW
        io: input
    &#39;}
    fFlowRate: LREAL;
END_VAR


END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-ppm">
<h2>POU: FB_PPM<a class="headerlink" href="#pou-fb-ppm" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/PPM/FB_PPM.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_PPM
VAR_IN_OUT
    stYStage: DUT_MotionStage;
END_VAR
VAR_INPUT
    fOut: LREAL;
    fPower: LREAL;
    fPolished: LREAL;
    fFrosted: LREAL;
END_VAR
VAR
    fbYStage: FB_MotionStage;

    {attribute &#39;pytmc&#39; := &#39;
        pv: MMS:STATE
        io: i
    &#39;}
    fbStates: FB_PPM_States;

    {attribute &#39;pytmc&#39; := &#39;
        pv: SPM
    &#39;}
    fbPowerMeter: FB_PPM_PowerMeter;

    {attribute &#39;pytmc&#39; := &#39;
        pv: CAM
    &#39;}
    fbGige: FB_PPM_Gige;

    {attribute &#39;pytmc&#39; :=&#39;
        pv: SFM
    &#39;}
    fbFlowMeter: FB_L2SI_Flowmeter;

    {attribute &#39;pytmc&#39; := &#39;
        pv: YAG
        io: input
    &#39;}
    fbYagThermoCouple: FB_ThermoCouple;
END_VAR
fbYStage(stMotionStage:=stYStage);
fbStates(
    stMotionStage:=stYStage,
    bEnable := TRUE,
    fOut:=fOut,
    fPower:=fPower,
    fPolished:=fPolished,
    fFrosted:=fFrosted);
stYStage.bHardwareEnable := TRUE;
stYStage.bPowerSelf := TRUE;
stYStage.nEnableMode := ENUM_StageEnableMode.DURING_MOTION;
fbPowerMeter();
fbGige();
fbFlowMeter();
fbYagThermoCouple();

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-ppm-gige">
<h2>POU: FB_PPM_Gige<a class="headerlink" href="#pou-fb-ppm-gige" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/PPM/FB_PPM_Gige.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_PPM_Gige
VAR
    iIlluminatorINT AT %Q*: INT;

    {attribute &#39;pytmc&#39; := &#39;
        pv: PWR
        ZNAM: OFF
        ONAM: ON
    &#39;}
    bGigePower AT %Q*: BOOL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: CIL:PCT
        EGU: %
    &#39;}
    fIlluminatorPercent: LREAL;

    fbGetIllPercent: FB_AnalogInput;
    fbSetIllPercent: FB_AnalogOutput;

    bGigeInit: BOOL := FALSE;
END_VAR
// Turn the GigE on by default
IF NOT bGigeInit THEN
    bGigePower := TRUE;
    bGigeInit := TRUE;
END_IF

// Illuminator conversion to percentage
fbSetIllPercent(
    fReal:=fIlluminatorPercent,
    fSafeMax:=100,
    fSafeMin:=0,
    iTermBits:=15,
    fTermMax:=100,
    fTermMin:=0,
    iRaw=&gt;iIlluminatorINT);
fbGetIllPercent(
    iRaw:=iIlluminatorINT,
    iTermBits:=15,
    fTermMax:=100,
    fTermMin:=0,
    fReal=&gt;fIlluminatorPercent);

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-ppm-powermeter">
<h2>POU: FB_PPM_PowerMeter<a class="headerlink" href="#pou-fb-ppm-powermeter" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/PPM/FB_PPM_PowerMeter.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_PPM_PowerMeter
VAR
    iVoltageINT AT %I*: INT;

    {attribute &#39;pytmc&#39; := &#39;
        pv: VOLT
        io: input
        field: EGU mV
    &#39;}
    fVoltage: LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: VOLT_BUFFER
        io: input
        field: EGU mV
    &#39;}
    fVoltageBuffer: ARRAY[1..1000] OF LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: CALIB
        io: input
    &#39;}
    fCalibBase: LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: CALIB_BUFFER
        io: input
    &#39;}
    fCalibBaseBuffer: ARRAY[1..1000] OF LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: MJ
        io: input
        field: EGU mJ
    &#39;}
    fCalibMJ: LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: MJ_BUFFER
        io: input
        field: EGU mJ
    &#39;}
    fCalibMJBuffer: ARRAY[1..1000] OF LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv:
        io: input
    &#39;}
    fbThermoCouple: FB_ThermoCouple;

    {attribute &#39;pytmc&#39; := &#39;
        pv: CALIB:OFFSET
        io: io
    &#39;}
    fCalibRelOffset: LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: CALIB:RATIO
        io: io
    &#39;}
    fCalibRelRatio: LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: CALIB:MJ_RATIO
        io: io
    &#39;}
    fCalibMJRatio: LREAL;

    fbGetPMVoltage: FB_AnalogInput;
    fbVoltageBuffer: FB_LREALBuffer;
    fbCalibBaseBuffer: FB_LREALBuffer;
    fbCalibMJBuffer: FB_LREALBuffer;
END_VAR
fbThermoCouple();

// Convert the terminal&#39;s integer into a value in millivolts
fbGetPMVoltage(
    iRaw := iVoltageINT,
    iTermBits := 15,
    fTermMax := 10000,
    fTermMin := 0,
    fReal =&gt; fVoltage);

// Power meter calibration
fCalibBase := (fVoltage + fCalibRelOffset) * fCalibRelRatio;
fCalibMJ := fCalibBase * fCalibMJRatio;

// Buffer the full-rate Voltage and calibrated MJ values
fbVoltageBuffer(
    bExecute := TRUE,
    fInput := fVoltage,
    arrOutput =&gt; fVoltageBuffer);
fbCalibBaseBuffer(
    bExecute := TRUE,
    fInput := fCalibBase,
    arrOutput =&gt; fCalibBaseBuffer);
fbCalibMJBuffer(
    bExecute := TRUE,
    fInput := fCalibMJ,
    arrOutput =&gt; fCalibMJBuffer);

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-ppm-states">
<h2>POU: FB_PPM_States<a class="headerlink" href="#pou-fb-ppm-states" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/PPM/FB_PPM_States.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_PPM_States
VAR_IN_OUT
    stMotionStage: DUT_MotionStage;
END_VAR
VAR_INPUT
    bEnable: BOOL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: SET
        io: io
    &#39;}
    enumSet: ENUM_PPM_states;
    bStatesLock: BOOL;
    fOut: LREAL;
    fPower: LREAL;
    fPolished: LREAL;
    fFrosted: LREAL;
END_VAR
VAR_OUTPUT
    bError: BOOL;
    sErrorMessage: STRING;
    bBusy: BOOL;
    bDone: BOOL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: GET
        io: i
    &#39;}
    enumGet: ENUM_PPM_States;
END_VAR
VAR
    bInit: BOOL;
    arrStates: ARRAY[1..15] OF DUT_PositionState;
    nIter: INT;

    {attribute &#39;pytmc&#39; := &#39;
        pv:
        io: io
    &#39;}
    fbStateManager: FB_PositionStateManager;

    fbLockOut: FB_PositionStateLock;
    fbLockPowerMeter: FB_PositionStateLock;
    fbLockPolishedYag: FB_PositionStateLock;
    fbLockFrostedYag: FB_PositionStateLock;
END_VAR
VAR CONSTANT
    fInDelta: LREAL := 0.1;
    fOutDelta: LREAL := 10;
    fInVelocity: LREAL := 80;
    fOutVelocity: LREAL := 65;
    fAccel: LREAL := 200;
    fOutDecel: LREAL := 25;
END_VAR
IF NOT bInit THEN
    bInit := FALSE;
    FOR nIter := 1 TO 4 DO
        arrStates[nIter].fDelta := fInDelta;
        arrStates[nIter].fVelocity := fInVelocity;
        arrStates[nIter].fAccel := fAccel;
        arrStates[nIter].fDecel := fAccel;
        arrStates[nIter].bLocked := bStatesLock;
        arrStates[nIter].bValid := TRUE;
        // TODO implement PMPS instead of doing this
        arrStates[nIter].bMoveOk := TRUE;
    END_FOR
    arrStates[1].sName := &#39;Out&#39;;
    arrStates[1].fPosition := fOut;
    arrStates[1].fDelta := fOutDelta;
    arrStates[1].fVelocity := fOutVelocity;
    arrStates[1].fDecel := fOutDecel;
    arrStates[2].sName := &#39;PowerMeter&#39;;
    arrStates[2].fPosition := fPower;
    arrStates[3].sName := &#39;PolishedYag&#39;;
    arrStates[3].fPosition := fPolished;
    arrStates[4].sName := &#39;FrostedYag&#39;;
    arrStates[4].fPosition := fFrosted;
END_IF

fbLockOut(stPositionState := arrStates[1]);
fbLockPowerMeter(stPositionState := arrStates[2]);
fbLockPolishedYag(stPositionState := arrStates[3]);
fbLockFrostedYag(stPositionState := arrStates[4]);

fbStateManager(
    stMotionStage := stMotionStage,
    arrStates := arrStates,
    setState := enumSet,
    bEnable := bEnable,
    bError =&gt; bError,
    sErrorMessage =&gt; sErrorMessage,
    bBusy =&gt; bBusy,
    bDone =&gt; bDone,
    getState =&gt; enumGet);

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-ref">
<h2>POU: FB_REF<a class="headerlink" href="#pou-fb-ref" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/REF/FB_REF.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_REF
VAR_IN_OUT
    stYStage: DUT_MotionStage;
END_VAR
VAR_INPUT
    fIn: LREAL;
    fOut: LREAL;
END_VAR
VAR
    fbYStage: FB_MotionStage;
    {attribute &#39;pytmc&#39; := &#39;
        pv: MMS:STATE
        io: io
    &#39;}
    fbStates: FB_EpicsInOut;

    {attribute &#39;pytmc&#39; := &#39;
        pv: LAS
        io: io
    &#39;}
    fbLaser: FB_REF_Laser;

    bInit: BOOL;
    stOut: DUT_PositionState;
    stIn: DUT_PositionState;
END_VAR
VAR CONSTANT
    bStatesLock: BOOL := FALSE;
    fVelo: LREAL := 65;
    fAccel: LREAL := 25;
END_VAR
IF NOT bInit THEN
    bInit := TRUE;
    stOut.fPosition := fOut;
    stOut.fDelta := 10;
    stOut.fVelocity := fVelo;
    stOut.fAccel := fAccel;
    stOut.fDecel := fAccel;
    stOut.bLocked := bStatesLock;
    stOut.bValid := TRUE;
    stOut.bMoveOk := TRUE;

    stIn.fPosition := fIn;
    stIn.fDelta := 0.1;
    stIn.fVelocity := fVelo;
    stIn.fAccel := fAccel;
    stIn.fDecel := fAccel;
    stIn.bLocked := bStatesLock;
    stIn.bValid := TRUE;
    stIn.bMoveOk := TRUE;
END_IF

fbYStage(stMotionStage:=stYStage);
fbStates(
    stMotionStage:=stYStage,
    stOut := stOut,
    stIn := stIn);
stYStage.bHardwareEnable := TRUE;
stYStage.bPowerSelf := TRUE;
stYStage.nEnableMode := ENUM_StageEnableMode.DURING_MOTION;
fbLaser();

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-ref-laser">
<h2>POU: FB_REF_Laser<a class="headerlink" href="#pou-fb-ref-laser" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/REF/FB_REF_Laser.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_REF_Laser
VAR_INPUT
    bShutdown: BOOL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: PCT
        io: io
    &#39;}
    fLaserPercent: LREAL;
END_VAR
VAR
    iShutdownINT AT %Q*: INT;
    iLaserINT AT %Q*: INT;

    fbGetLasPercent: FB_AnalogInput;
    fbSetLasPercent: FB_AnalogOutput;
END_VAR
// Send 5V to suppress laser
IF bShutdown THEN
    iShutdownINT := LREAL_TO_INT(EXPT(2, 14));
ELSE
    iShutdownINT := 0;
END_IF

// Limit to 0-5V instead of 10V
fbSetLasPercent(
    fReal:=fLaserPercent,
    fSafeMax:=100,
    fSafeMin:=0,
    iTermBits:=15,
    fTermMax:=200,
    fTermMin:=0,
    iRaw=&gt;iLaserInt);
fbGetLasPercent(
    iRaw:=iLaserInt,
    iTermBits:=15,
    fTermMax:=200,
    fTermMin:=0,
    fReal=&gt;fLaserPercent);

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-slits">
<h2>POU: FB_SLITS<a class="headerlink" href="#pou-fb-slits" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/SLITS/FB_SLITS.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SLITS</span>


<span class="n">END_FUNCTION_BLOCK</span>
<span class="n">ACTION</span> <span class="n">ACT_BLOCK</span><span class="o">:</span>

<span class="n">END_ACTION</span>
<span class="n">ACTION</span> <span class="n">ACT_CalculatePositions</span><span class="o">:</span>

<span class="n">END_ACTION</span>
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-slits-power">
<h2>POU: FB_SLITS_POWER<a class="headerlink" href="#pou-fb-slits-power" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/SLITS/FB_SLITS_POWER.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_SLITS_POWER EXTENDS FB_SLITS
VAR_IN_OUT
    stTopBlade: DUT_MotionStage;
    stBottomBlade: DUT_MotionStage;
    stNorthBlade: DUT_MotionStage;
    stSouthBlade: DUT_MotionStage;
END_VAR
VAR_INPUT
    {attribute &#39;pytmc&#39; := &#39;
    pv: GO;
    io: io;
    field: ZNAM False
    field: ONAM True
    &#39;}
    bExecuteMotion:BOOL ;
    {attribute &#39;pytmc&#39; := &#39;
    pv: PMPS_OK;
    io: i;
    field: ZNAM False
    field: ONAM True
    &#39;}
    bMoveOk:BOOL;
END_VAR
VAR_OUTPUT
END_VAR
VAR
    fbTopBlade: FB_MotionStage;
    fbBottomBlade: FB_MotionStage;
    fbNorthBlade: FB_MotionStage;
    fbSouthBlade: FB_MotionStage;
    fPosTopBlade: LREAL;
    fPosBottomBlade: LREAL;
    fPosNorthBlade: LREAL;
    fPosSouthBlade: LREAL;

    (*Motion Parameters*)
    fSmallDelta: LREAL := 0.01;
    fBigDelta: LREAL := 10;
    fMaxVelocity: LREAL := 0.2;
    fHighAccel: LREAL := 0.8;
    fLowAccel: LREAL := 0.1;

    stTop: DUT_PositionState;
    stBOTTOM: DUT_PositionState;
    stNorth: DUT_PositionState;
    stSouth: DUT_PositionState;

    {attribute &#39;pytmc&#39; := &#39;pv: TOP&#39;}
    fbTop: FB_StatePTPMove;
    {attribute &#39;pytmc&#39; := &#39;pv: BOTTOM&#39;}
    fbBottom: FB_StatePTPMove;
    {attribute &#39;pytmc&#39; := &#39;pv: NORTH&#39;}
    fbNorth: FB_StatePTPMove;
    {attribute &#39;pytmc&#39; := &#39;pv: SOUTH&#39;}
    fbSouth: FB_StatePTPMove;

    (*EPICS pvs*)
    {attribute &#39;pytmc&#39; := &#39;
    pv: XWID_REQ;
    io: io;
    &#39;}
    rReqApertureSizeX : REAL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: YWID_REQ;
    io: io;
    &#39;}
    rReqApertureSizeY : REAL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: XCEN_REQ;
    io: io;
    &#39;}
    rReqCenterX: REAL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: YCEN_REQ;
    io: io;
    &#39;}
    rReqCenterY: REAL;

    {attribute &#39;pytmc&#39; := &#39;
    pv: ACTUAL_XWIDTH;
    io: io;
    &#39;}
    rActApertureSizeX : REAL;

    {attribute &#39;pytmc&#39; := &#39;
    pv: ACTUAL_YWIDTH;
    io: io;
    &#39;}
    rActApertureSizeY : REAL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: ACTUAL_XCENTER;
    io: io;
    &#39;}
    rActCenterX: REAL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: ACTUAL_YCENTER;
    io: io;
    &#39;}
    rActCenterY: REAL;

    {attribute &#39;pytmc&#39; := &#39;
    pv: XCEN_SETZERO;
    io: io;
    &#39;}
    rSetCenterX: REAL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: YCEN_SETZERO;
    io: io;
    &#39;}
    rSetCenterY: REAL;


    {attribute &#39;pytmc&#39; := &#39;
    pv: OPEN;
    io: io;
    field: ZNAM False
    field: ONAM True
    &#39;}
    bOpen: BOOL;

    {attribute &#39;pytmc&#39; := &#39;
    pv: CLOSE;
    io: io;
    field: ZNAM False
    field: ONAM True
    &#39;}
    bClose: BOOL;

    {attribute &#39;pytmc&#39; := &#39;
    pv: BLOCK;
    io: io;
    field: ZNAM False
    field: ONAM True
    &#39;}
    bBlock: BOOL;


    {attribute &#39;pytmc&#39; := &#39;
        pv: FSW
    &#39;}
    fbFlowSwitch: FB_XTES_Flowswitch;


    //RTDs
    {attribute &#39;pytmc&#39; := &#39;
        pv: TOP:RTD:01
    &#39;}
    RTD_TOP_1: FB_TempSensor;
    {attribute &#39;pytmc&#39; := &#39;
        pv: TOP:RTD:02
    &#39;}
    RTD_TOP_2: FB_TempSensor;
    {attribute &#39;pytmc&#39; := &#39;
        pv: BOTTOM:RTD:01
    &#39;}
    RTD_Bottom_1: FB_TempSensor;
    {attribute &#39;pytmc&#39; := &#39;
        pv: BOTTOM:RTD:02
    &#39;}
    RTD_Bottom_2: FB_TempSensor;

    {attribute &#39;pytmc&#39; := &#39;
        pv: NORTH:RTD:01
    &#39;}
    RTD_North_1: FB_TempSensor;
    {attribute &#39;pytmc&#39; := &#39;
        pv: NORTH:RTD:02
    &#39;}
    RTD_North_2: FB_TempSensor;
    {attribute &#39;pytmc&#39; := &#39;
        pv: SOUTH:RTD:01
    &#39;}
    RTD_South_1: FB_TempSensor;
    {attribute &#39;pytmc&#39; := &#39;
        pv: SOUTH:RTD:02
    &#39;}
    RTD_South_2: FB_TempSensor;

        //Local variables
    bInit: BOOL :=true;
    rTrig_Block: R_TRIG;
    rTrig_Open: R_TRIG;
    rTrig_Close: R_TRIG;

    fPosBlock: LREAL;
    fPosClose: LREAL;
    fPosOpen: LREAL;


END_VAR
//  init the motion stages parameters
IF ( bInit) THEN
    stTopBlade.bHardwareEnable := TRUE;
    stBottomBlade.bHardwareEnable := TRUE;
    stNorthBlade.bHardwareEnable := TRUE;
    stSouthBlade.bHardwareEnable := TRUE;
    stTopBlade.bPowerSelf :=TRUE;
    stBottomBlade.bPowerSelf :=TRUE;
    stNorthBlade.bPowerSelf :=TRUE;
    stSouthBlade.bPowerSelf :=TRUE;
    stTopBlade.nBrakeMode := ENUM_StageBrakeMode.NO_BRAKE;
    stBottomBlade.nBrakeMode := ENUM_StageBrakeMode.NO_BRAKE;
    stNorthBlade.nBrakeMode := ENUM_StageBrakeMode.NO_BRAKE;
    stSouthBlade.nBrakeMode := ENUM_StageBrakeMode.NO_BRAKE;
END_IF


// Instantiate Function block for all the blades
fbTopBlade(stMotionStage:=stTopBlade);
fbBottomBlade(stMotionStage:=stBottomBlade);
fbNorthBlade(stMotionStage:=stNorthBlade);
fbSouthBlade(stMotionStage:=stSouthBlade);

//SET and GET the requested and Actual values
ACT_CalculatePositions();
//ACT_BLOCK();

// PTP Motion for each blade
stTop.sName := &#39;Top&#39;;
stTop.fPosition := fPosTopBlade;
stTop.fDelta := fSmallDelta;
stTop.fVelocity := fMaxVelocity;
stTop.fAccel := fHighAccel;
stTop.fDecel := fHighAccel;

stBOTTOM.sName := &#39;Bottom&#39;;
stBOTTOM.fPosition := fPosBottomBlade;
stBOTTOM.fDelta := fSmallDelta;
stBOTTOM.fVelocity := fMaxVelocity;
stBOTTOM.fAccel := fHighAccel;
stBOTTOM.fDecel := fHighAccel;

stNorth.sName := &#39;North&#39;;
stNorth.fPosition := fPosNorthBlade;
stNorth.fDelta := fSmallDelta;
stNorth.fVelocity := fMaxVelocity;
stNorth.fAccel := fHighAccel;
stNorth.fDecel := fHighAccel;

stSouth.sName := &#39;South&#39;;
stSouth.fPosition := fPosSouthBlade;
stSouth.fDelta := fSmallDelta;
stSouth.fVelocity := fMaxVelocity;
stSouth.fAccel := fHighAccel;
stSouth.fDecel := fHighAccel;

fbTop.bExecute := fbBottom.bExecute :=fbNorth.bExecute := fbSouth.bExecute := bExecuteMotion;

fbTop(
    stPositionState:=stTop,
    bMoveOk:=bMoveOk,
    stMotionStage:=stTopBlade);

fbBottom(
    stPositionState:=stBOTTOM,
    bMoveOk:=bMoveOk,
    stMotionStage:=stBottomBlade);

fbNorth(
    stPositionState:=stNorth,
    bMoveOk:=bMoveOk,
    stMotionStage:=stNorthBlade);

fbSouth(
    stPositionState:=stSouth,
    bMoveOk:=bMoveOk,
    stMotionStage:=stSouthBlade);


////RTDs
RTD_TOP_1();
RTD_TOP_2();
RTD_Bottom_1();
RTD_Bottom_2();
RTD_North_1();
RTD_North_2();
RTD_South_1();
RTD_South_2();

//Flow Switch
fbFlowSwitch();

END_FUNCTION_BLOCK
ACTION ACT_BLOCK:
rTrig_Block (CLK:= bBlock);
rTrig_Open (CLK:= bOpen);
rTrig_Close (CLK:= bClose);

if (rTrig_Block.Q) THEN
    //BLOCK

    bBlock := false;
END_IF

if (rTrig_Open.Q) THEN


    bOpen := false;
END_IF

if (rTrig_Close.Q) THEN


    bClose := false;
END_IF
END_ACTION
ACTION ACT_CalculatePositions:
//Calculate requested Positions


fPosTopBlade := (rReqApertureSizeY/2) + rReqCenterY;
fPosBottomBlade := (-1*rReqApertureSizeY/2) + rReqCenterY;

fPosNorthBlade := (rReqApertureSizeX/2) + rReqCenterX;
fPosSouthBlade := (-1*rReqApertureSizeX/2) + rReqCenterX;


//Calculate Actual Positions


rActApertureSizeX := ABS(stNorthBlade.stAxisStatus.fActPosition - stSouthBlade.stAxisStatus.fActPosition);

rActApertureSizeY := ABS(stTopBlade.stAxisStatus.fActPosition - stBottomBlade.stAxisStatus.fActPosition);

rActCenterX := ((stNorthBlade.stAxisStatus.fActPosition + stSouthBlade.stAxisStatus.fActPosition)/2);

rActCenterY := ((stTopBlade.stAxisStatus.fActPosition + stBottomBlade.stAxisStatus.fActPosition)/2);



//ZERO BIAS

// Set Y center to zero

// Set X center to zero
END_ACTION
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-xpim">
<h2>POU: FB_XPIM<a class="headerlink" href="#pou-fb-xpim" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/XPIM/FB_XPIM.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_XPIM
VAR_IN_OUT
    stYStage: DUT_MotionStage;
    stZoomStage: DUT_MotionStage;
    stFocusStage: DUT_MotionStage;
    stEl6In: EL6inData22b;
    stEl6Out: EL6OutData22b;
END_VAR
VAR_INPUT
    bZoomEndFwd AT %I*: BOOL;
    bZoomEndBwd AT %I*: BOOL;
    bFocusEndFwd AT %I*: BOOL;
    bFocusEndBwd AT %I*: BOOL;

    fYag: LREAL;
    fDiamond: LREAL;
    fReticle: LREAL;
    fOut: LREAL;
END_VAR
VAR
    fbYStage: FB_MotionStage;
    fbZoom: FB_MotionStage;
    fbFocus: FB_MotionStage;

    {attribute &#39;pytmc&#39; := &#39;
        pv: MMS:STATE
        io: io
    &#39;}
    fbStates: FB_XPIM_States;

    {attribute &#39;pytmc&#39; := &#39;
        pv: MFW
    &#39;}
    fbFilterWheel: FB_XPIM_FilterWheel;

    {attribute &#39;pytmc&#39; := &#39;
        pv: CAM
    &#39;}
    fbOpal: FB_XPIM_Opal;

    {attribute &#39;pytmc&#39; := &#39;
        pv: SFW
    &#39;}
    fbFlowSwitch: FB_XTES_Flowswitch;
END_VAR
fbYStage(stMotionStage:=stYStage);
// All stages have no STO
stYStage.bHardwareEnable := TRUE;
stZoomStage.bHardwareEnable := TRUE;
stFocusStage.bHardwareEnable := TRUE;
// No PMPS yet
stYStage.bPowerSelf := TRUE;
stZoomStage.bPowerSelf := TRUE;
stFocusStage.bPowerSelf := TRUE;
// No limit switch at the bottom
stYStage.bLimitBackwardEnable := TRUE;
// Lens limits are normally open
stZoomStage.bLimitForwardEnable := NOT bZoomEndFwd;
stZoomStage.bLimitBackwardEnable := NOT bZoomEndBwd;
stFocusStage.bLimitForwardEnable := NOT bFocusEndFwd;
stFocusStage.bLimitBackwardEnable := NOT bFocusEndBwd;
// Home Lens to LLS
stZoomStage.nHomingMode := ENUM_EpicsHomeCmd.LOW_LIMIT;
stFocusStage.nHomingMode := ENUM_EpicsHomeCmd.LOW_LIMIT;
fbStates(
    stMotionStage:=stYStage,
    fYag:=fYag,
    fDiamond:=fDiamond,
    fReticle:=fReticle,
    fOut:=fOut);
fbZoom(stMotionStage:=stZoomStage);
fbFocus(stMotionStage:=stFocusStage);
fbFilterWheel(
    bExecute:=TRUE,
    stIn_El6:=stEl6In,
    stOut_El6:=stEl6Out);
fbOpal();
fbFlowSwitch();

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-xpim-filterwheel">
<h2>POU: FB_XPIM_FilterWheel<a class="headerlink" href="#pou-fb-xpim-filterwheel" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/XPIM/FB_XPIM_FilterWheel.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_XPIM_FilterWheel
VAR_INPUT
    bExecute: BOOL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: ERR:RESET
        io: output
    &#39;}
    bResetError: BOOL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: SET
        io: io
    &#39;}
    nSetPos: ENUM_XPIM_Filters;
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
        pv: GET
        io: i
    &#39;}
    nGetPos: ENUM_XPIM_Filters;
    bBusy: BOOL;
    bError: BOOL;
    sError: STRING;
    {attribute &#39;pytmc&#39; := &#39;
        pv: ERR:MSG
        io: input
    &#39;}
    sLastError: STRING;
    sErrorTS: STRING;
END_VAR
VAR_IN_OUT
    stIn_EL6: EL6inData22B;
    stOut_EL6: EL6outData22B;
END_VAR
VAR
    {attribute &#39;pytmc&#39; := &#39;
        pv: RAW
    &#39;}
    fbCom: FB_EL6_COM;

    nStep: USINT;
    sLastTestCmd: STRING;
    bIsTest: BOOL;
    fbGetTime: NT_GetTime;
    bStopOnErr: BOOL;
END_VAR
fbCom.sSendSuffix := &#39;$R&#39;;
fbCom.sRecvSuffix := &#39;$R&#39;;

IF bExecute AND nStep = 0 THEN
    IF bResetError OR NOT bError THEN
        nStep := 10;
    END_IF
ELSIF NOT bExecute THEN
    nStep := 0;
END_IF
CASE nStep OF
    0:
        ; // idle
    10:
        // Get position
        bIsTest := FALSE;
        fbCom(sCmd:=&#39;pos?&#39;,
            bSend:=TRUE,
            stIn_EL6:=stIn_EL6,
            stOut_EL6:=stOut_EL6);
        nStep := nStep + 10;
    20:
        // Wait for response and set variables
        fbCom(stIn_EL6:=stIn_EL6,
            stOut_EL6:=stOut_EL6);
        IF fbCom.bDone THEN
            bError := FALSE;
            sError := &#39;&#39;;
            nGetPos := STRING_TO_USINT(fbCom.sResponse);
            nSetPos := nGetPos;
            nStep := nStep + 10;
            IF nGetPos = 0 THEN
                sError := &#39;Filter wheel in invalid state&#39;;
                bStopOnErr := TRUE;
                nStep := 50;
            END_IF
        END_IF
    30:
        // Wait for a move request
        IF nSetPos &lt;&gt; nGetPos THEN
            fbCom(sCmd:=CONCAT(&#39;pos=&#39;, INT_TO_STRING(nSetPos)),
                bSend:=TRUE,
                stIn_EL6:=stIn_EL6,
                stOut_EL6:=stOut_EL6);
            nStep := nStep + 10;
            bBusy := TRUE;
        END_IF
    40:
        fbCom(stIn_EL6:=stIn_EL6,
            stOut_EL6:=stOut_EL6);
        // Wait for move to be done
        IF fbCom.bDone THEN
            bBusy := FALSE;
            nStep := 10;
            // Handle setpoint error
            IF fbCom.sResponse = &#39;Command error CMD_ARG_INVALID$N$R&#39; THEN
                sError := &#39;Invalid set position&#39;;
                nStep := 50;
            END_IF
        END_IF
    50:
        // Set sError and then jump here for standard handling
        sLastError := sError;
        bError := TRUE;
        fbGetTime(NETID:=&#39;&#39;,
            START:=TRUE);
        nStep := nStep + 10;
    60:
        // Error handling continued
        fbGetTime();
        IF NOT fbGetTime.BUSY THEN
            sErrorTS := SYSTEMTIME_TO_STRING(fbGetTime.TIMESTR);
            fbGetTime.START := FALSE;
            // set bStopOnErr to TRUE if it was a major error
            IF bStopOnErr THEN
                nStep := 0;
            ELSE
                nStep := 10;
            END_IF
            bStopOnErr := FALSE;
        END_IF
END_CASE
// Check for inner comms errors, report to EPICS same way
IF NOT bError AND
    (fbCom.eRecvErrorID &lt;&gt; COMERROR_NOERROR
    OR fbCom.eSendErrorID &lt;&gt; COMERROR_NOERROR
    OR fbCom.eRecvErrorID &lt;&gt; COMERROR_NOERROR) THEN
    sError := &#39;Serial Communication Error&#39;;
    bStopOnErr := TRUE;
    nStep := 50;
END_IF

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-xpim-opal">
<h2>POU: FB_XPIM_Opal<a class="headerlink" href="#pou-fb-xpim-opal" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/XPIM/FB_XPIM_Opal.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_XPIM_Opal
VAR
    {attribute &#39;pytmc&#39; := &#39;
        pv: PWR
        io: io
        ZNAM: OFF
        ONAM: ON
    &#39;}
    bOpalPower AT %Q*: BOOL;
    bOpalInit: BOOL := FALSE;

    {attribute &#39;pytmc&#39; := &#39;
        pv: CIL:PWR
        io: io
        ZNAM: OFF
        ONAM: ON
    &#39;}
    bLedPower AT %Q*: BOOL;
END_VAR
// Turn the Opal on by default
IF NOT bOpalInit THEN
    bOpalPower := TRUE;
    bOpalInit := TRUE;
END_IF

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-xpim-states">
<h2>POU: FB_XPIM_States<a class="headerlink" href="#pou-fb-xpim-states" title="Permalink to this headline">¶</a></h2>
<p>File: Library/Devices/XPIM/FB_XPIM_States.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_XPIM_States
VAR_IN_OUT
    stMotionStage: DUT_MotionStage;
END_VAR
VAR_INPUT
    bEnable: BOOL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: SET
        io: io
    &#39;}
    enumSet: ENUM_XPIM_states;
    bStatesLock: BOOL;
    fOut: LREAL;
    fYag: LREAL;
    fDiamond: LREAL;
    fReticle: LREAL;
END_VAR
VAR_OUTPUT
    bError: BOOL;
    sErrorMessage: STRING;
    bBusy: BOOL;
    bDone: BOOL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: GET
        io: i
    &#39;}
    enumGet: ENUM_XPIM_States;
END_VAR
VAR
    bInit: BOOL;
    arrStates: ARRAY[1..15] OF DUT_PositionState;
    nIter: INT;

    {attribute &#39;pytmc&#39; := &#39;
        pv:
        io: io
    &#39;}
    fbStateManager: FB_PositionStateManager;

    fbLockOut: FB_PositionStateLock;
    fbLockYag: FB_PositionStateLock;
    fbLockDiamond: FB_PositionStateLock;
    fbLockReticle: FB_PositionStateLock;
END_VAR
VAR CONSTANT
    fInDelta: LREAL := 0.1;
    fOutDelta: LREAL := 10;
    fInVelocity: LREAL := 20;
    fOutVelocity: LREAL := 20;
    fAccel: LREAL := 200;
    fOutDecel: LREAL := 25;
END_VAR
IF NOT bInit THEN
    bInit := FALSE;
    FOR nIter := 1 TO 4 DO
        arrStates[nIter].fDelta := fInDelta;
        arrStates[nIter].fVelocity := fInVelocity;
        arrStates[nIter].fAccel := fAccel;
        arrStates[nIter].fDecel := fAccel;
        arrStates[nIter].bLocked := bStatesLock;
        arrStates[nIter].bValid := TRUE;
        // TODO implement PMPS instead of doing this
        arrStates[nIter].bMoveOk := TRUE;
    END_FOR
    arrStates[1].sName := &#39;Out&#39;;
    arrStates[1].fPosition := fOut;
    arrStates[1].fDelta := fOutDelta;
    arrStates[1].fVelocity := fOutVelocity;
    arrStates[1].fDecel := fOutDecel;
    arrStates[2].sName := &#39;Yag&#39;;
    arrStates[2].fPosition := fYag;
    arrStates[3].sName := &#39;Diamond&#39;;
    arrStates[3].fPosition := fDiamond;
    arrStates[4].sName := &#39;Reticle&#39;;
    arrStates[4].fPosition := fReticle;
END_IF

fbLockOut(stPositionState := arrStates[1]);
fbLockYag(stPositionState := arrStates[2]);
fbLockDiamond(stPositionState := arrStates[3]);
fbLockReticle(stPositionState := arrStates[4]);

fbStateManager(
    stMotionStage := stMotionStage,
    arrStates := arrStates,
    setState := enumSet,
    bEnable := bEnable,
    bError =&gt; bError,
    sErrorMessage =&gt; sErrorMessage,
    bBusy =&gt; bBusy,
    bDone =&gt; bDone,
    getState =&gt; enumGet);

END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="pou-fb-xtes-flowswitch">
<h2>POU: FB_XTES_Flowswitch<a class="headerlink" href="#pou-fb-xtes-flowswitch" title="Permalink to this headline">¶</a></h2>
<p>File: Library/POUs/FB_XTES_Flowswitch.TcPOU</p>
<div class="highlight-vhdl notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_XTES_Flowswitch
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
        pv: FLOW
        ZNAM: LOW
        ONAM: OK
    &#39;}
    bFlowOk AT %I*: BOOL;
END_VAR


END_FUNCTION_BLOCK
</pre></div>
</div>
</div>
<div class="section" id="symbols">
<h2>Symbols<a class="headerlink" href="#symbols" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="boxes">
<h2>Boxes<a class="headerlink" href="#boxes" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="nc-axes">
<h2>NC axes<a class="headerlink" href="#nc-axes" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="links">
<h2>Links<a class="headerlink" href="#links" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="pragma-lint-results">
<h2>Pragma lint results<a class="headerlink" href="#pragma-lint-results" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span><span class="n">pytmc</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">pragmalint</span><span class="p">:</span><span class="n">Total</span> <span class="n">pragmas</span> <span class="n">found</span><span class="p">:</span> <span class="mi">75</span> <span class="n">Total</span> <span class="n">linter</span> <span class="n">errors</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">PLC</span> <span class="n">Project</span> <span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">Library</span>
<span class="o">========================</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">PPM</span><span class="o">/</span><span class="n">ENUM_PPM_States</span><span class="o">.</span><span class="n">TcDUT</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-----------------------------------------------</span>

    <span class="o">-</span> <span class="n">ENUM_PPM_States</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">PPM</span><span class="o">/</span><span class="n">FB_PPM</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">--------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_PPM</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">5</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">PPM</span><span class="o">/</span><span class="n">FB_PPM_Gige</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_PPM_Gige</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">2</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">PPM</span><span class="o">/</span><span class="n">FB_PPM_PowerMeter</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-------------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_PPM_PowerMeter</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">10</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">PPM</span><span class="o">/</span><span class="n">FB_PPM_States</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">---------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_PPM_States</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">3</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">REF</span><span class="o">/</span><span class="n">FB_REF</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">--------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_REF</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">2</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">REF</span><span class="o">/</span><span class="n">FB_REF_Laser</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">--------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_REF_Laser</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">SLITS</span><span class="o">/</span><span class="n">FB_SLITS_POWER</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">------------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_SLITS_POWER</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">28</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">ENUM_XPIM_Filters</span><span class="o">.</span><span class="n">TcDUT</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">--------------------------------------------------</span>

    <span class="o">-</span> <span class="n">ENUM_XPIM_Filters</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">ENUM_XPIM_States</span><span class="o">.</span><span class="n">TcDUT</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-------------------------------------------------</span>

    <span class="o">-</span> <span class="n">ENUM_XPIM_States</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">FB_XPIM</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">----------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_XPIM</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">4</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">FB_XPIM_FilterWheel</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">----------------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_XPIM_FilterWheel</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">5</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">FB_XPIM_Opal</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">---------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_XPIM_Opal</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">2</span> <span class="n">pragmas</span>


<span class="n">Devices</span><span class="o">/</span><span class="n">XPIM</span><span class="o">/</span><span class="n">FB_XPIM_States</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-----------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_XPIM_States</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">3</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">FB_L2SI_Flowmeter</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_L2SI_Flowmeter</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">2</span> <span class="n">pragmas</span>


<span class="n">POUs</span><span class="o">/</span><span class="n">FB_XTES_Flowswitch</span><span class="o">.</span><span class="n">TcPOU</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">-------------------------------------------</span>

    <span class="o">-</span> <span class="n">FB_XTES_Flowswitch</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">pragmas</span>


<span class="n">Version</span><span class="o">/</span><span class="n">Global_Version</span><span class="o">.</span><span class="n">TcGVL</span> <span class="p">(</span><span class="n">TcPlcObject</span><span class="p">)</span>
<span class="o">------------------------------------------</span>

    <span class="o">-</span> <span class="n">Global_Version</span><span class="p">:</span> <span class="n">Declaration</span> <span class="o">-</span> <span class="mi">4</span> <span class="n">pragmas</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">pcdshub/lcls2-cc-lib</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Library.tmc.html">Library.tmc</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">PLC Project (1): Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dut-enum-ppm-states">DUT: ENUM_PPM_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-enum-xpim-filters">DUT: ENUM_XPIM_Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-enum-xpim-states">DUT: ENUM_XPIM_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-global-version">GVL: Global_Version</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-l2si-flowmeter">POU: FB_L2SI_Flowmeter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-ppm">POU: FB_PPM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-ppm-gige">POU: FB_PPM_Gige</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-ppm-powermeter">POU: FB_PPM_PowerMeter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-ppm-states">POU: FB_PPM_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-ref">POU: FB_REF</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-ref-laser">POU: FB_REF_Laser</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-slits">POU: FB_SLITS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-slits-power">POU: FB_SLITS_POWER</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-xpim">POU: FB_XPIM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-xpim-filterwheel">POU: FB_XPIM_FilterWheel</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-xpim-opal">POU: FB_XPIM_Opal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-xpim-states">POU: FB_XPIM_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pou-fb-xtes-flowswitch">POU: FB_XTES_Flowswitch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#symbols">Symbols</a></li>
<li class="toctree-l2"><a class="reference internal" href="#boxes">Boxes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nc-axes">NC axes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#links">Links</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pragma-lint-results">Pragma lint results</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="Library.tmc.html" title="previous chapter">Library.tmc</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, SLAC National Accelerator Laboratory.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/lcls2-cc-lib.tsproj.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>